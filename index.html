<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
<title>Day-Out Planner – Chennai (Cloud Sync)</title>
<style>
  :root{--brand:#ff5722;--accent:#0088cc;--bg:#fff8ef}
  *{box-sizing:border-box;margin:0;padding:0}
  body{background:var(--bg);font-family:system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
       display:flex;flex-direction:column;min-height:100vh;color:#333}
  header{background:var(--brand);color:#fff;padding:.75rem 1rem;display:flex;gap:.75rem;flex-wrap:wrap;align-items:center}
  header h1{font-size:1.25rem;flex:1}
  nav{display:flex;gap:.4rem;flex-wrap:wrap}
  nav button{margin:0;padding:.45rem .8rem;border:none;border-radius:.6rem;background:#fff;
             color:var(--brand);font-weight:600;cursor:pointer}
  nav button.active{background:#ffe5d1;color:#000}
  .who{font-weight:600;background:#ffe5d1;color:#5a3a28;padding:.3rem .6rem;border-radius:.5rem}
  main{flex:1;max-width:1200px;margin:0 auto;padding:1rem}
  .hidden{display:none}

  .profile-container{display:flex;flex-wrap:wrap;gap:1rem}
  .profile-card{background:#fff;border:2px solid var(--accent);border-radius:1rem;padding:1rem;
                flex:1 1 320px;position:relative;box-shadow:0 4px 8px rgba(0,0,0,.06)}
  .profile-card h3{margin-top:0;color:var(--brand)}
  .delete-profile{position:absolute;top:.5rem;right:.5rem;background:#e53935;color:#fff;border:none;
                  width:24px;height:24px;border-radius:50%;font-weight:bold;cursor:pointer}
  .place-item{display:flex;gap:.25rem;margin:.3rem 0;align-items:center}
  .place-item input{flex:1;padding:.35rem .6rem;border:1px solid #ccc;border-radius:.4rem}
  button{padding:.45rem .7rem;border:none;border-radius:.5rem;background:var(--brand);color:#fff;cursor:pointer;min-height:40px}
  button.icon{width:36px;height:36px;padding:0}
  .lock{opacity:.6}
  .map-wrap{height:48vh;min-height:220px;border-radius:1rem;overflow:hidden;box-shadow:0 4px 8px rgba(0,0,0,.06);margin-top:1rem}
  @media (min-width:900px){ .map-wrap{height:420px} }

  #votingContent{overflow-x:auto}
  #votingContent table{width:100%;min-width:560px;border-collapse:collapse}
  #votingContent th,#votingContent td{border:1px solid #ddd;padding:.4rem;text-align:left;vertical-align:top}
  #votingContent th{background:#ffe5d1}

  /* Calendar */
  .calendar-wrap{margin-top:1rem;background:#fff;border:2px solid var(--accent);border-radius:1rem;padding:1rem;box-shadow:0 4px 8px rgba(0,0,0,.06)}
  .cal-toolbar{display:flex;gap:.5rem;align-items:center;justify-content:space-between;margin-bottom:.75rem;flex-wrap:wrap}
  .cal-title{font-weight:800;color:var(--accent)}
  .cal-grid{display:grid;grid-template-columns:repeat(7,minmax(38px,1fr));gap:.35rem}
  .cal-dow{font-size:.85rem;color:#666;text-align:center}
  .cal-day{background:#fff8ef;border:1px solid #f1d5c0;border-radius:.75rem;min-height:80px;padding:.35rem;display:flex;flex-direction:column;gap:.35rem;cursor:pointer;position:relative}
  .cal-day.other-month{opacity:.45}
  .cal-day .date-no{font-weight:700;color:#444;font-size:.9rem}
  .cal-day .tags{display:flex;flex-wrap:wrap;gap:.25rem;margin-top:auto}
  .tag{font-size:.72rem;line-height:1;background:#fff;border:1px solid #e4c9b3;border-radius:.6rem;padding:.12rem .35rem;white-space:nowrap}
  .badge{position:absolute;top:.25rem;right:.25rem;min-width:1.2rem;padding:.02rem .3rem;border-radius:1rem;background:#ffe5d1;border:1px solid #f1d5c0;text-align:center;font-size:.7rem;color:#555}
  .legend{display:flex;gap:.4rem;flex-wrap:wrap;margin-top:.75rem}
  .chip{display:inline-flex;align-items:center;gap:.35rem;padding:.25rem .5rem;border:1px solid #ddd;background:#fff;border-radius:1rem;cursor:pointer}
  .chip.active{outline:2px solid var(--accent); outline-offset:1px}
  .cal-help{font-size:.9rem;color:#555}
  .chip.lock{opacity:.5;cursor:not-allowed}

  /* Comments */
  .chat-wrap{background:#fff;border:2px solid var(--accent);border-radius:1rem;padding:1rem;display:flex;flex-direction:column;gap:.75rem}
  .chat-list{display:flex;flex-direction:column;gap:.5rem;max-height:50vh;overflow:auto;padding-right:.25rem}
  .msg{display:flex;gap:.5rem;align-items:flex-start}
  .bubble{background:#fff8ef;border:1px solid #f1d5c0;border-radius:1rem;padding:.5rem .7rem;max-width:80%}
  .meta{font-size:.75rem;color:#666;margin-top:.15rem}
  .chat-input{display:flex;gap:.5rem}
  .chat-input input{flex:1;padding:.5rem;border:1px solid #ccc;border-radius:.5rem}

  /* Suggestions */
  .sugg-wrap{background:#fff;border:2px solid var(--accent);border-radius:1rem;padding:1rem;display:flex;flex-direction:column;gap:.75rem}
  .sugg-input{display:flex;gap:.5rem;align-items:center;flex-wrap:wrap}
  .sugg-input input{flex:1;min-width:220px;padding:.5rem;border:1px solid #ccc;border-radius:.5rem}
  .sugg-list{display:flex;flex-direction:column;gap:.5rem;max-height:50vh;overflow:auto}
  .sugg-item{display:flex;justify-content:space-between;align-items:flex-start;gap:.75rem;border:1px solid #eee;border-radius:.75rem;padding:.5rem .6rem;background:#fff8ef}
  .sugg-item small{color:#666}

  /* Extra small screens */
  @media (max-width:420px){
    body { font-size:15px }
    header h1{ font-size:1.05rem }
    .cal-title{ font-size:1rem }
    .chip{ font-size:.9rem }
    main{ padding:.75rem }
  }
</style>
</head>
<body>
<header>
  <h1>Day-Out Planner – Chennai</h1>
  <nav>
    <button id="btnProfiles" class="active" onclick="switchTab('profiles')">Profiles</button>
    <button id="btnSuggestions" onclick="switchTab('suggestions')">Suggestions</button>
    <button id="btnVoting"  onclick="switchTab('voting')">Voting</button>
    <button id="btnCalendar" onclick="switchTab('calendar')">Calendar</button>
    <button id="btnComments" onclick="switchTab('comments')">Comments</button>
  </nav>
  <span id="whoAmI" class="who hidden"></span>
  <button onclick="addProfile()">➕ Add Profile</button>
</header>

<main>
  <section id="tab-profiles"><div id="profilesArea" class="profile-container"></div></section>

  <!-- Suggestions Tab -->
  <section id="tab-suggestions" class="hidden">
    <h2>Suggestions</h2>
    <p class="cal-help">Search with Google and stash good places here. The Voting tab uses this list (deduped).</p>
    <div class="sugg-wrap">
      <div class="sugg-input">
        <input id="suggSearch" placeholder="Search places… (e.g., Marina Beach, Murugan Idli)" />
        <button onclick="addSuggestion()">Add</button>
      </div>
      <div class="sugg-list" id="suggList"></div>
    </div>
  </section>

  <section id="tab-voting" class="hidden">
    <h2>Group Voting</h2>
    <p>Voting is based on the <strong>Suggestions</strong> list below. Vote only for your own profile.</p>
    <div id="votingContent"></div>
  </section>

  <!-- Calendar Tab -->
  <section id="tab-calendar" class="hidden">
    <h2>Availability Calendar</h2>
    <p class="cal-help">Everyone’s availability is visible. Tap a date to toggle for <em>your</em> profile.</p>
    <div class="calendar-wrap">
      <div class="cal-toolbar">
        <div>
          <button id="calPrev" onclick="calNav(-1)">◀</button>
          <span class="cal-title" id="calMonthTitle">Month YYYY</span>
          <button id="calNext" onclick="calNav(1)">▶</button>
          <span style="margin-left:.5rem;color:#666" id="calEditWho"></span>
        </div>
      </div>
      <div class="cal-grid" id="calGrid"></div>
      <div class="legend" id="calLegend"></div>
    </div>
  </section>

  <!-- Comments Tab -->
  <section id="tab-comments" class="hidden">
    <h2>Comments (Post-it board)</h2>
    <div class="chat-wrap">
      <div id="claimHint" class="cal-help">Claim your profile to post. Tap your profile chip below.</div>
      <div class="legend" id="commentLegend"></div>
      <div class="chat-list" id="chatList"></div>
      <div class="chat-input">
        <input id="chatText" placeholder="Write a note…">
        <button id="chatPostBtn" onclick="sendComment()">Post</button>
      </div>
    </div>
  </section>

  <div class="map-wrap"><div id="sharedMap" style="height:100%"></div></div>
  <div id="routeSummary" style="margin-top:.5rem;font-weight:600;color:#0088cc"></div>
</main>

<footer>Made with ❤ in Chennai — data shared via Firebase</footer>

<script type="module">
/* Firebase */
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.18.0/firebase-app.js";
import { getFirestore, doc, getDoc, setDoc, onSnapshot, collection, addDoc, query, orderBy, limit, serverTimestamp, onSnapshot as colSnap } from "https://www.gstatic.com/firebasejs/9.18.0/firebase-firestore.js";
import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.18.0/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyBmQKBxtBi15JNs6IltRFQ6sYjTUiMUW7I",
  authDomain: "day-out-planner.firebaseapp.com",
  projectId: "day-out-planner",
  storageBucket: "day-out-planner.firebasestorage.app",
  messagingSenderId: "595882210469",
  appId: "1:595882210469:web:c8a70ea594348fe7e8c94c"
};
const app = initializeApp(firebaseConfig);
const db  = getFirestore(app);
const auth = getAuth(app);
const globalRef = doc(db,"planner","global");
const commentsCol    = collection(globalRef, "comments");     // existing subcollection
const suggestionsCol = collection(globalRef, "suggestions");  // NEW subcollection

/* State */
let uid = null;
let state = { profiles: [], votes: {}, avails: {}, owners: {} };
let myPid = null;
let suggestions = []; // live cache of /planner/global/suggestions
const CHENNAI = {lat:13.0827,lng:80.2707};

/* Colours may still be used in cards etc. */
function paletteHueAt(i,total){ return Math.round((i * 360/Math.max(total,1)) % 360); }
function colour(pid){ const p = profileById(pid); return p?.color || 'hsl(0,0%,80%)'; }

/* Helpers */
const pad = n => n<10 ? '0'+n : ''+n;
const formatDate = d => `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
const stopsOf = pid => [...document.querySelectorAll(`#${pid}-list li`)].map(li=>li.firstChild.nodeValue.trim());
function profileById(pid){ return state.profiles.find(p=>p.id===pid); }
function profileName(pid){ return profileById(pid)?.name || 'Unknown'; }
function initials(name){
  if(!name) return '?';
  const parts = name.trim().split(/\s+/).slice(0,3);
  return parts.map(w=>w[0]?.toUpperCase()).join('');
}

/* ---- Claim / PIN / device lock (unchanged) ---- */
const DEVICE_LOCK_KEY = 'deviceClaimedPid';
const getDeviceClaimedPid = () => { try { return localStorage.getItem(DEVICE_LOCK_KEY); } catch { return null; } };
const setDeviceClaimedPid = (pid) => { try { localStorage.setItem(DEVICE_LOCK_KEY, pid); } catch {} };
const clearDeviceClaimIf = (pid) => { try { if (localStorage.getItem(DEVICE_LOCK_KEY) === pid) localStorage.removeItem(DEVICE_LOCK_KEY); } catch {} };

function ownersOf(pid){
  const p = profileById(pid);
  if (!p) return [];
  if (!p.owners && p.claimedBy) p.owners = [p.claimedBy];
  if (!Array.isArray(p.owners)) p.owners = [];
  if (!state.owners) state.owners = {};
  state.owners[pid] = p.owners;
  return p.owners;
}
function iOwn(pid){ return ownersOf(pid).includes(uid); }
function loadMyPid(){ try{ myPid = localStorage.getItem('myPid')||null; }catch(e){} }
function saveMyPid(){ try{ myPid ? localStorage.setItem('myPid', myPid) : localStorage.removeItem('myPid'); }catch(e){} }

/* Auth bootstrap */
onAuthStateChanged(auth, async user=>{
  if(!user){ await signInAnonymously(auth); return; }
  uid = user.uid;
  loadMyPid();
  await cloudLoad();

  if (!myPid) {
    const mine = state.profiles.find(p => ownersOf(p.id).includes(uid));
    if (mine) { myPid = mine.id; saveMyPid(); if (!getDeviceClaimedPid()) setDeviceClaimedPid(mine.id); }
  }

  drawUI();
  startCommentsLive();
  startSuggestionsLive();
});

/* Firestore sync (planner/global doc) */
async function cloudLoad(){
  const s=await getDoc(globalRef);
  if(s.exists()){
    const d=s.data();
    state = { profiles:d.profiles||[], votes:d.votes||{}, avails:d.avails||{}, owners:d.owners||{} };
    ensureProfileColours();
  }
}
const cloudSave = ()=> setDoc(globalRef,state);
onSnapshot(globalRef,s=>{ if(s.exists()){ const d=s.data(); state={profiles:d.profiles||[],votes:d.votes||{},avails:d.avails||{}, owners:d.owners||{}}; ensureProfileColours(); drawUI(); }});

/* Profile colours persisted (used in non-calendar UI) */
function ensureProfileColours(){
  let changed=false;
  const total = state.profiles.length;
  state.profiles.forEach((p, idx)=>{
    if(!p.color){ p.color = `hsl(${paletteHueAt(idx,total)},70%,75%)`; changed=true; }
  });
  if(changed) cloudSave();
}

/* Claim flow */
async function claimProfile(pid){
  const p = profileById(pid); if(!p) return alert('Profile not found');

  const devicePid = getDeviceClaimedPid();
  if (devicePid && devicePid !== pid) {
    alert(`This device is already tied to "${profileName(devicePid)}". One device can use only one profile.`);
    return;
  }

  if (!Array.isArray(p.owners)) { p.owners = []; if (p.claimedBy && !p.owners.includes(p.claimedBy)) p.owners.push(p.claimedBy); }

  if (p.owners.includes(uid)) { setDeviceClaimedPid(pid); selectMyProfile(pid); return; }

  if (p.owners.length === 0) {
    const pin = prompt(`Set a PIN for "${p.name}" (4–10 chars):`);
    if (!pin || pin.length < 4) return alert('PIN too short.');
    p.pin = pin;
    p.owners.push(uid);
    if (!state.owners) state.owners = {}; state.owners[pid] = p.owners;
    await cloudSave();
    setDeviceClaimedPid(pid);
    selectMyProfile(pid);
    return;
  }

  const entered = prompt(`Enter PIN for "${p.name}" to use it on this device:`);
  if (!entered || entered !== p.pin) return alert('Incorrect PIN');

  p.owners.push(uid);
  if (!state.owners) state.owners = {}; state.owners[pid] = p.owners;
  await cloudSave();
  setDeviceClaimedPid(pid);
  selectMyProfile(pid);
}
function selectMyProfile(pid){
  myPid = pid; saveMyPid();
  if (!getDeviceClaimedPid()) setDeviceClaimedPid(pid);
  updateWho();
  renderProfiles();
  renderVoting();
  if (!document.getElementById('tab-calendar').classList.contains('hidden')) drawCalendar();
  if (!document.getElementById('tab-comments').classList.contains('hidden')) renderCommentLegend();
  if (!document.getElementById('tab-suggestions').classList.contains('hidden')) renderSuggestions();
}
async function setOrChangePin(pid){
  const p = profileById(pid); if(!p) return;
  if(!iOwn(pid)) return alert('Only an existing owner can change the PIN.');
  const pin = prompt(`Set/Change PIN for "${p.name}" (4–10 chars):`, p.pin||'');
  if(!pin || pin.length<4) return alert('PIN too short.');
  p.pin = pin;
  await cloudSave();
  alert('PIN updated.');
}

/* Tabs */
function switchTab(t){
  ['profiles','suggestions','voting','calendar','comments'].forEach(n=>{
    document.getElementById('tab-'+n).classList.toggle('hidden',t!==n);
    document.getElementById('btn'+n.charAt(0).toUpperCase()+n.slice(1)).classList.toggle('active',t===n);
  });
  if(t==='voting') renderVoting();
  if(t==='calendar') renderCalendarUI();
  if(t==='comments') renderCommentLegend();
  if(t==='suggestions') renderSuggestions();
}
function updateWho(){
  const el=document.getElementById('whoAmI');
  if(myPid){ el.textContent = `You: ${profileName(myPid)}`; el.classList.remove('hidden'); }
  else { el.textContent = ''; el.classList.add('hidden'); }
}

/* Profiles */
function addProfile(){
  const name=prompt('Profile name'); if(!name)return;
  const id='p'+Date.now();
  state.profiles.push({id,name,stops:[], claimedBy:null, owners:[], pin:null, color:`hsl(${paletteHueAt(state.profiles.length, state.profiles.length+1)},70%,75%)`});
  if(!state.owners) state.owners={}; state.owners[id]=[];
  cloudSave(); drawUI();
}
function deleteProfile(id){
  state.profiles=state.profiles.filter(p=>p.id!==id); state.votes={};
  Object.keys(state.avails||{}).forEach(d=>{
    if(state.avails[d]?.[id]) delete state.avails[d][id];
    if(Object.keys(state.avails[d]).length===0) delete state.avails[d];
  });
  if(state.owners) delete state.owners[id];
  if(myPid===id) { myPid=null; saveMyPid(); clearDeviceClaimIf(id); }
  cloudSave(); drawUI();
}
function renderProfiles(){
  const area=document.getElementById('profilesArea'); area.innerHTML='';
  state.profiles.forEach(p=>{
    const owned = iOwn(p.id);
    const devicePid = getDeviceClaimedPid();
    const deviceLockedDifferent = devicePid && devicePid !== p.id;

    const card=document.createElement('div'); card.className='profile-card'; card.id=p.id;
    card.style.borderColor = colour(p.id);

    const claimBtnHtml = owned
      ? `<button onclick="selectMyProfile('${p.id}')">Use on this device</button>`
      : (deviceLockedDifferent
          ? `<button disabled class="lock" title="This device is tied to '${profileName(devicePid)}'">Claim this profile</button>`
          : `<button onclick="claimProfile('${p.id}')" style="background:#4caf50">Claim this profile</button>`);

    card.innerHTML=`
      <button class="delete-profile" onclick="deleteProfile('${p.id}')">×</button>
      <h3>${p.name}</h3>
      <div style="display:flex;gap:.5rem;flex-wrap:wrap;margin-bottom:.5rem">
        ${claimBtnHtml}
        <button onclick="setOrChangePin('${p.id}')" class="${owned?'':'lock'}">Set/Change PIN</button>
      </div>
      <label>Start <input id="${p.id}-start" value="${p.start||''}" ${owned?'':'disabled'}></label><br/>
      <label>End   <input id="${p.id}-end"   value="${p.end||''}" ${owned?'':'disabled'}></label>
      <div class="place-item"><input id="${p.id}-stop" placeholder="Add stop" ${owned?'':'disabled'}>
        <button ${owned?'':'disabled'} onclick="addStop('${p.id}')">▶</button></div>
      <ul id="${p.id}-list"></ul>
      <!-- Always enabled so anyone can preview the route -->
      <button onclick="drawRoute('${p.id}')">Show Route</button>`;
    area.appendChild(card);

    (p.stops||[]).forEach(s=>addStop(p.id,s,true));

    if (window.google?.maps?.places){
      ['start','end','stop'].forEach(f=>{
        const el=document.getElementById(`${p.id}-${f}`);
        if (el && !el.disabled) new google.maps.places.Autocomplete(el);
      });
    }
    const sEl=document.getElementById(`${p.id}-start`);
    const eEl=document.getElementById(`${p.id}-end`);
    if(sEl) sEl.onchange = ()=>{ saveStops(p.id); cloudSave(); };
    if(eEl) eEl.onchange = ()=>{ saveStops(p.id); cloudSave(); };
  });
}

/* Stops (unchanged; personal routes, not voting) */
function addStop(pid, val = '', silent = false){
  const isRestore = !!silent;
  if (!iOwn(pid) && !isRestore) { alert('Claim this profile to edit.'); return; }
  const inp = document.getElementById(pid+'-stop');
  const text = val || inp?.value.trim(); if (!text) return;

  const li = document.createElement('li'); li.className='place-item'; li.textContent = text;
  li.append(
    btn('↑',()=>{ if(li.previousElementSibling) li.parentNode.insertBefore(li, li.previousElementSibling); saveStops(pid); }),
    btn('↓',()=>{ if(li.nextElementSibling)     li.parentNode.insertBefore(li.nextElementSibling, li); saveStops(pid); }),
    btn('✖',()=>{ li.remove(); saveStops(pid); })
  );
  document.getElementById(pid+'-list').appendChild(li);

  if (!isRestore && inp) inp.value='';
  if (!isRestore) saveStops(pid);
}
const btn=(txt,fn)=>{const b=document.createElement('button');b.textContent=txt;b.className='icon';b.onclick=fn;return b;}
const saveStops=pid=>{const p=profileById(pid); if(!p) return; p.stops=stopsOf(pid); cloudSave(); };

/* Map */
let map,svc,rend;
function mapSetup(){
  if(!window.google?.maps) return;
  map=new google.maps.Map(document.getElementById('sharedMap'),{center:CHENNAI,zoom:11});
  svc=new google.maps.DirectionsService();
  rend=new google.maps.DirectionsRenderer({map});
}
function drawRoute(pid){
  if(!(window.google?.maps && svc && rend)) return alert('Map not ready');
  const p = profileById(pid);
  if(!p) return alert('Profile not found');
  const start = p.start || document.getElementById(pid+'-start')?.value?.trim();
  const end   = p.end   || document.getElementById(pid+'-end')  ?.value?.trim();
  const stops = Array.isArray(p.stops) && p.stops.length ? p.stops : stopsOf(pid);
  if(!start || !end || !stops || !stops.length){
    return alert("This profile hasn't set start, end, and at least one stop yet.");
  }
  if(iOwn(pid)){ Object.assign(p, { start, end, stops }); cloudSave(); }
  svc.route({
    origin: start, destination: end,
    waypoints: stops.map(s => ({ location: s, stopover: true })), travelMode: 'DRIVING'
  }, (res, status) => {
    if(status!=='OK') return alert('Directions failed: '+status);
    rend.setDirections(res);
    const legs = res.routes[0].legs;
    const dist = (legs.reduce((d,l)=>d+l.distance.value,0)/1000).toFixed(1);
    const time = (legs.reduce((t,l)=>t+l.duration.value,0)/60).toFixed(0);
    document.getElementById('routeSummary').textContent = `${p.name}'s plan → ${dist} km | ${time} mins`;
  });
}

/* Suggestions live */
let unsubscribeSuggestions = null;
function startSuggestionsLive(){
  if(unsubscribeSuggestions) unsubscribeSuggestions();
  const q = query(suggestionsCol, orderBy('ts','desc'), limit(200));
  unsubscribeSuggestions = colSnap(q, snap=>{
    suggestions = [];
    snap.forEach(d=>{ const s=d.data(); suggestions.push({ id:d.id, ...s }); });
    if(!document.getElementById('tab-suggestions').classList.contains('hidden')) renderSuggestions();
    if(!document.getElementById('tab-voting').classList.contains('hidden')) renderVoting();
  });
}

let suggAC=null; // autocomplete instance
function ensureSuggAutocomplete(){
  if(suggAC || !window.google?.maps?.places) return;
  const inp=document.getElementById('suggSearch');
  if(!inp) return;
  suggAC = new google.maps.places.Autocomplete(inp, {
    fields:['place_id','name','formatted_address','geometry']
  });
}
async function addSuggestion(){
  ensureSuggAutocomplete();
  const inp=document.getElementById('suggSearch');
  if(!inp) return;
  let place = suggAC?.getPlace?.();
  // If user typed and hit Add without choosing dropdown, fallback to text
  if(!place || !place.place_id){
    const txt=inp.value.trim();
    if(!txt) return;
    const existsByName = suggestions.some(s => (s.name||'').toLowerCase()===txt.toLowerCase());
    if(existsByName){ alert('Already suggested.'); return; }
    await addDoc(suggestionsCol, {
      placeId: `name:${txt.toLowerCase()}`,
      name: txt,
      address: '',
      addedBy: myPid || 'anon',
      uid, ts: serverTimestamp()
    });
    inp.value='';
    return;
  }
  // Deduplicate by place_id
  if(suggestions.some(s=>s.placeId===place.place_id)){
    alert('Already suggested.');
    inp.value=''; return;
  }
  await addDoc(suggestionsCol, {
    placeId: place.place_id,
    name: place.name || '',
    address: place.formatted_address || '',
    addedBy: myPid || 'anon',
    uid,
    ts: serverTimestamp()
  });
  inp.value='';
}
function renderSuggestions(){
  ensureSuggAutocomplete();
  const list=document.getElementById('suggList'); if(!list) return;
  if(suggestions.length===0){ list.innerHTML='<em>No suggestions yet. Try adding a few!</em>'; return; }
  list.innerHTML='';
  suggestions.forEach(s=>{
    const row=document.createElement('div'); row.className='sugg-item';
    const left=document.createElement('div');
    left.innerHTML = `<div><strong>${s.name||'(Unnamed)'}</strong></div>
                      <small>${s.address||''}</small>
                      <div><small>by ${profileName(s.addedBy)||'Someone'}</small></div>`;
    row.appendChild(left);
    list.appendChild(row);
  });
}

/* Voting — now based on Suggestions (deduped by placeId) */
function renderVoting(){
  const box=document.getElementById('votingContent');
  const uniqMap = new Map();
  suggestions.forEach(s=>{ if(!uniqMap.has(s.placeId)) uniqMap.set(s.placeId, s); });
  const uniq = [...uniqMap.values()];
  if(uniq.length===0){ box.innerHTML='<em>No suggestions yet — add some in the Suggestions tab.</em>'; return; }

  let html='<table><thead><tr><th style="min-width:220px">Place</th>';
  state.profiles.forEach(p=>html+=`<th>${p.name}</th>`); html+='<th>👍</th><th>👎</th></tr></thead><tbody>';

  uniq.forEach(s=>{
    const key = s.placeId;
    const row = state.votes[key] || {};
    html+=`<tr><td><div><strong>${s.name}</strong></div><div><small>${s.address||''}</small></div></td>`;
    state.profiles.forEach(p=>{
      const up=row[p.id];
      const enabled = iOwn(p.id);
      html+=`<td style="text-align:center">
              <button ${enabled?'':'disabled class="lock"'} onclick="toggleVote('${key}','${p.id}')">
                ${up?'👍':'👎'}
              </button>
            </td>`;
    });
    html+=`<td style="text-align:center">${cnt(row,true)}</td><td style="text-align:center">${cnt(row,false)}</td></tr>`;
  });

  html+='</tbody></table>'; box.innerHTML=html;
}
const toggleVote=(key,pid)=>{
  if(!iOwn(pid)) return alert('Claim this profile to vote for it.');
  if(!state.votes[key]) state.votes[key]={};
  state.votes[key][pid]=!state.votes[key][pid]; cloudSave(); renderVoting();
};
const cnt=(o,val)=>Object.values(o).filter(x=>x===val).length;

/* Calendar (names/initials instead of colours) */
let calCurrent = new Date();
function renderCalendarUI(){
  const leg = document.getElementById('calLegend'); leg.innerHTML='';
  state.profiles.forEach(p=>{
    const chip=document.createElement('span');
    chip.className='chip'+(myPid===p.id?' active':'')+(iOwn(p.id)?'':' lock');
    chip.dataset.pid = p.id;
    chip.textContent = p.name;
    leg.appendChild(chip);
  });
  leg.onclick = (e)=>{
    const chip=e.target.closest('.chip'); if(!chip) return;
    const pid=chip.dataset.pid;
    if(iOwn(pid)) { selectMyProfile(pid); highlightLegend('calLegend'); return; }
    claimProfile(pid);
  };
  document.getElementById('calEditWho').textContent = myPid ? `Editing: ${profileName(myPid)}` : 'Not claimed';
  drawCalendar(); highlightLegend('calLegend');
}
function highlightLegend(containerId){
  const c=document.getElementById(containerId);
  c.querySelectorAll('.chip').forEach(el=>el.classList.remove('active'));
  if(myPid){ const el=c.querySelector(`.chip[data-pid="${myPid}"]`); if(el) el.classList.add('active'); }
}
function calNav(step){ calCurrent.setMonth(calCurrent.getMonth()+step); drawCalendar(); }

function drawCalendar(){
  const grid=document.getElementById('calGrid');
  const title=document.getElementById('calMonthTitle');
  grid.innerHTML='';

  const y=calCurrent.getFullYear(), m=calCurrent.getMonth();
  const monthStart=new Date(y,m,1);
  const monthEnd=new Date(y,m+1,0);
  const startDay=(monthStart.getDay()+6)%7;
  const totalDays=monthEnd.getDate();

  title.textContent = monthStart.toLocaleString(undefined,{month:'long', year:'numeric'});

  ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'].forEach(d=>{
    const el=document.createElement('div'); el.className='cal-dow'; el.textContent=d; grid.appendChild(el);
  });

  const prevDays = startDay;
  if(prevDays>0){
    const prevEnd = new Date(y,m,0).getDate();
    for(let i=prevDays-1;i>=0;i--) grid.appendChild(makeDayCell(new Date(y,m-1,prevEnd-i), true));
  }
  for(let d=1; d<=totalDays; d++) grid.appendChild(makeDayCell(new Date(y,m,d), false));

  const cellsSoFar = 7 + prevDays + totalDays;
  const trailing = (7*7 - cellsSoFar % 7) % 7;
  for(let i=1;i<=trailing;i++) grid.appendChild(makeDayCell(new Date(y,m+1,i), true));
}

function makeDayCell(dateObj, otherMonth){
  const cell=document.createElement('div');
  cell.className='cal-day' + (otherMonth ? ' other-month':'');
  const dateStr = formatDate(dateObj);

  const no=document.createElement('div'); no.className='date-no'; no.textContent = dateObj.getDate();
  const tags=document.createElement('div'); tags.className='tags';

  const dayAv = state.avails?.[dateStr] || {};
  const freePids = Object.keys(dayAv).filter(pid=>dayAv[pid]);

  freePids.slice(0,4).forEach(pid=>{
    const t=document.createElement('span'); t.className='tag';
    t.textContent = initials(profileName(pid));
    t.title = profileName(pid);
    tags.appendChild(t);
  });
  if(freePids.length>4){
    const more=document.createElement('span'); more.className='tag'; more.textContent = `+${freePids.length-4}`;
    tags.appendChild(more);
  }
  if(freePids.length){
    const badge=document.createElement('div'); badge.className='badge'; badge.textContent=freePids.length;
    cell.appendChild(badge);
  }

  cell.appendChild(no);
  cell.appendChild(tags);

  cell.onclick = ()=>{
    if(!myPid) return alert('Claim your profile first.');
    if(!state.avails) state.avails = {};
    if(!state.avails[dateStr]) state.avails[dateStr] = {};
    state.avails[dateStr][myPid] = !state.avails[dateStr][myPid];
    if(!state.avails[dateStr][myPid]) delete state.avails[dateStr][myPid];
    if(Object.keys(state.avails[dateStr]).length===0) delete state.avails[dateStr];
    cloudSave(); drawCalendar();
  };

  return cell;
}

/* Comments (owner-only posting; unchanged) */
let unsubscribeComments = null;
function renderCommentLegend(){
  const leg = document.getElementById('commentLegend'); leg.innerHTML='';
  state.profiles.forEach(p=>{
    const chip=document.createElement('span');
    chip.className='chip'+(myPid===p.id?' active':'')+(iOwn(p.id)?'':' lock');
    chip.dataset.pid=p.id;
    chip.textContent = p.name;
    leg.appendChild(chip);
  });
  leg.onclick = (e)=>{
    const chip=e.target.closest('.chip'); if(!chip) return;
    const pid=chip.dataset.pid;
    if(iOwn(pid)) { selectMyProfile(pid); highlightLegend('commentLegend'); updatePostButtonState(); return; }
    claimProfile(pid);
  };
  highlightLegend('commentLegend');
  document.getElementById('claimHint').textContent = myPid ? `Posting as ${profileName(myPid)}` : `Claim your profile to post.`;
  updatePostButtonState();
}
function startCommentsLive(){
  if(unsubscribeComments) unsubscribeComments();
  const q = query(commentsCol, orderBy('ts','desc'), limit(50));
  unsubscribeComments = colSnap(q, snap=>{
    const list=document.getElementById('chatList'); if(!list) return;
    list.innerHTML='';
    snap.forEach(docSnap=>{
      const m=docSnap.data();
      const row=document.createElement('div'); row.className='msg';
      const avatar=document.createElement('span'); avatar.className='tag'; avatar.textContent = initials(profileName(m.profileId||'')) || '?';
      const bubble=document.createElement('div'); bubble.className='bubble';
      const when = m.ts?.toDate?.()?.toLocaleString?.() || '';
      bubble.innerHTML = `<div>${m.text||''}</div><div class="meta">${profileName(m.profileId||'')||'Unknown'} • ${when}</div>`;
      row.appendChild(avatar); row.appendChild(bubble);
      list.appendChild(row);
    });
  });
}
function updatePostButtonState(){
  const btn = document.getElementById('chatPostBtn');
  if (!btn) return;
  btn.disabled = !myPid;
  btn.classList.toggle('lock', !myPid);
}
async function sendComment(){
  const inp=document.getElementById('chatText');
  const text=inp.value.trim();
  if(!text) return;
  if(!myPid) { alert('Claim your profile to post.'); return; }
  try{
    await addDoc(commentsCol, { text, profileId: myPid, uid, ts: serverTimestamp() });
    inp.value='';
  }catch(err){
    console.error(err);
    alert('Could not post: ' + (err?.message || err));
  }
}

/* Bootstrap */
function drawUI(){
  renderProfiles();
  if(!document.getElementById('tab-voting').classList.contains('hidden')) renderVoting();
  if(!document.getElementById('tab-calendar').classList.contains('hidden')) renderCalendarUI();
  if(!document.getElementById('tab-comments').classList.contains('hidden')) renderCommentLegend();
  if(!document.getElementById('tab-suggestions').classList.contains('hidden')) renderSuggestions();
  updateWho();
}
window.initMap = async function(){ try { mapSetup(); await cloudLoad(); drawUI(); } catch(e){ console.error(e); } };

/* Expose globals */
Object.assign(window,{
  addProfile, addStop, drawRoute, deleteProfile, switchTab,
  toggleVote, calNav, claimProfile, setOrChangePin,
  sendComment, selectMyProfile, addSuggestion
});
</script>

<!-- Google Maps loader -->
<script defer
  src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAyb1r4lm4HGtyr2nEOuVL-kSdyEosZVh4&libraries=places&callback=initMap"></script>
</body>
</html>
