<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Day-Out Planner ‚Äì Chennai (Persistent)</title>
<style>
  :root{--brand:#ff5722;--accent:#0088cc;--bg:#fff8ef}
  *{box-sizing:border-box;margin:0;padding:0}
  body{background:var(--bg);font-family:system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
       display:flex;flex-direction:column;min-height:100vh;color:#333}
  /* header/nav */
  header{background:var(--brand);color:#fff;padding:.75rem 1rem;display:flex;gap:1rem;flex-wrap:wrap;align-items:center}
  header h1{font-size:1.4rem;flex:1}
  nav button{margin:0 .25rem;padding:.4rem .8rem;border:none;border-radius:.6rem;background:#fff;
             color:var(--brand);font-weight:600;cursor:pointer}
  nav button.active{background:#ffe5d1;color:#000}
  /* main layout */
  main{flex:1;max-width:1200px;margin:0 auto;padding:1rem}
  .hidden{display:none}
  /* profile card */
  .profile-container{background:#fff;border:2px solid var(--accent);border-radius:1rem;padding:1rem;margin-bottom:1.2rem;
                     position:relative}
  .profile-header{display:flex;align-items:center;gap:.5rem;margin-bottom:.5rem}
  .color-pill{width:20px;height:20px;border-radius:50%}
  .delete-profile{position:absolute;top:.5rem;right:.5rem;width:24px;height:24px;border:none;border-radius:50%;
                  background:#e53935;color:#fff;font-weight:bold;cursor:pointer;line-height:20px}
  /* panels & inputs */
  .panel{background:#fff;border-radius:1rem;box-shadow:0 4px 8px rgba(0,0,0,.06);padding:1rem;margin:.5rem 0}
  .panel h3{margin-bottom:.5rem;color:var(--brand);font-size:1.1rem}
  .place-item{display:flex;gap:.25rem;margin-bottom:.4rem;align-items:center}
  .place-item input{flex:1;padding:.4rem .6rem;border:1px solid #ccc;border-radius:.4rem}
  button{padding:.35rem .6rem;border:none;border-radius:.5rem;background:var(--brand);color:#fff;cursor:pointer;
         transition:.1s}
  button:hover{transform:translateY(-1px)}
  button:active{transform:translateY(1px)}
  button.icon{width:2rem;padding:0}
  /* shared map */
  .map-wrap{height:420px;border-radius:1rem;overflow:hidden;box-shadow:0 4px 8px rgba(0,0,0,.06);margin-top:1rem}
  /* voting table */
  #votingContent table{width:100%;border-collapse:collapse}
  #votingContent th,#votingContent td{border:1px solid #ddd;padding:.4rem;text-align:left}
  #votingContent th{background:#ffe5d1}
  /* autocomplete dropdown above cards */
  .pac-container{z-index:10000 !important}
  footer{text-align:center;padding:.6rem;font-size:.85rem;color:#555}
</style>
</head>
<body>
<header>
  <h1>Day-Out Planner ‚Äì Chennai</h1>
  <nav>
    <button id="btnProfiles" class="active" onclick="switchTab('profiles')">Profiles</button>
    <button id="btnVoting"  onclick="switchTab('voting')">Voting</button>
  </nav>
  <button onclick="addProfile()">‚ûï Add Profile</button>
</header>

<main>
  <!-- Profiles tab -->
  <section id="tab-profiles"><div id="profilesArea"></div></section>

  <!-- Voting tab -->
  <section id="tab-voting" class="hidden">
    <h2>Group Voting</h2>
    <p>Click üëç under your name to vote for a place.</p>
    <div id="votingContent"></div>
  </section>

  <!-- shared map -->
  <div class="map-wrap"><div id="sharedMap" style="height:100%"></div></div>
  <div id="routeSummary" style="margin-top:.5rem;font-weight:600;color:var(--accent)"></div>
</main>

<footer>Made with ‚ù§ in Chennai ‚Äî data auto-saves in your browser</footer>

<script>
/* ===== persistence helpers ===== */
const KEY='dayOut_v2';
function load(){ try{return JSON.parse(localStorage.getItem(KEY))||{profiles:[],votes:{}};}catch{ return {profiles:[],votes:{}}; } }
function save(){ localStorage.setItem(KEY,JSON.stringify(state)); }

let   state=load();                        // {profiles:[{id,name,stops,start,end}], votes:{}}
const CHENNAI={lat:13.0827,lng:80.2707};
let   map,dirSvc,dirRend;

/* ===== tiny utils ===== */
const colour=id=>`hsl(${parseInt(id.slice(-4),10)%360},70%,80%)`;
const stopsOf=pid=>[...document.querySelectorAll(`#${pid}-list li`)].map(li=>li.firstChild.nodeValue.trim());

/* ===== Tabs ===== */
function switchTab(t){
  document.getElementById('tab-profiles').classList.toggle('hidden',t!=='profiles');
  document.getElementById('tab-voting'  ).classList.toggle('hidden',t!=='voting');
  document.getElementById('btnProfiles').classList.toggle('active',t==='profiles');
  document.getElementById('btnVoting'  ).classList.toggle('active',t==='voting');
  if(t==='voting') renderVoting();
}

/* ===== Profiles ===== */
function addProfile(){
  const name=prompt('Profile name'); if(!name)return;
  state.profiles.push({id:'p'+Date.now(),name,stops:[]});
  save(); renderProfiles(); renderVoting();
}
function deleteProfile(id){
  state.profiles=state.profiles.filter(p=>p.id!==id);
  state.votes={}; save();
  renderProfiles(); renderVoting();
}
function renderProfiles(){
  const area=document.getElementById('profilesArea'); area.innerHTML='';
  state.profiles.forEach(p=>{
    const card=document.createElement('div'); card.className='profile-container';
    card.innerHTML=`<button class="delete-profile" onclick="deleteProfile('${p.id}')">√ó</button>
      <div class="profile-header"><span class="color-pill" style="background:${colour(p.id)}"></span><strong>${p.name}</strong></div>
      <div class="panel">
        <h3>Route</h3>
        <label>Start <input id="${p.id}-start" value="${p.start||''}"></label><br><br>
        <label>End <input id="${p.id}-end" value="${p.end||''}"></label>
        <h4 style="margin:.5rem 0 .25rem;">Stops</h4>
        <div class="place-item"><input id="${p.id}-stop"><button onclick="addStop('${p.id}')">‚ñ∂</button></div>
        <ul id="${p.id}-list"></ul>
        <button onclick="drawRoute('${p.id}')">Show on Map</button>
      </div>`;
    area.appendChild(card);
    ['start','end','stop'].forEach(f=>new google.maps.places.Autocomplete(document.getElementById(`${p.id}-${f}`)));
    /* restore stop list */
    p.stops.forEach(s=>addStop(p.id,s,true));
  });
}

/* ===== Stops (add / reorder) ===== */
function addStop(pid,val='',silent=false){
  const inp=document.getElementById(pid+'-stop');
  const text=val||inp.value.trim(); if(!text)return;
  const li=document.createElement('li'); li.className='place-item'; li.textContent=text;

  const up =btn('‚Üë',()=>{if(li.previousElementSibling) li.parentNode.insertBefore(li,li.previousElementSibling); saveSt(pid);});
  const down=btn('‚Üì',()=>{if(li.nextElementSibling)     li.parentNode.insertBefore(li.nextElementSibling,li); saveSt(pid);});
  const del=btn('‚úñ',()=>{li.remove(); saveSt(pid);});
  li.append(up,down,del); document.getElementById(pid+'-list').appendChild(li);
  if(!silent) inp.value=''; if(!silent) saveSt(pid);
}
const btn=(txt,fn)=>{const b=document.createElement('button');b.textContent=txt;b.className='icon';b.onclick=fn;return b;}
const saveSt=pid=>{const p=state.profiles.find(x=>x.id===pid); p.stops=stopsOf(pid); save(); renderVoting();};

/* ===== Map ===== */
function initMap(){
  map=new google.maps.Map(document.getElementById('sharedMap'),{center:CHENNAI,zoom:11});
  dirSvc=new google.maps.DirectionsService();
  dirRend=new google.maps.DirectionsRenderer(); dirRend.setMap(map);
  renderProfiles(); renderVoting();
}
function drawRoute(pid){
  const p=state.profiles.find(x=>x.id===pid);
  const start=document.getElementById(pid+'-start').value.trim();
  const end  =document.getElementById(pid+'-end').value.trim();
  const stops=stopsOf(pid); if(!start||!end||stops.length===0){alert('Fill start, end & ‚â•1 stop');return;}
  Object.assign(p,{start,end,stops}); save();

  dirSvc.route({origin:start,destination:end,waypoints:stops.map(s=>({location:s,stopover:true})),
                travelMode:'DRIVING'},
   (res,status)=>{
     if(status==='OK'){
       dirRend.setDirections(res);
       const legs=res.routes[0].legs;
       const dist=(legs.reduce((d,l)=>d+l.distance.value,0)/1000).toFixed(1);
       const time=(legs.reduce((t,l)=>t+l.duration.value,0)/60).toFixed(0);
       document.getElementById('routeSummary').textContent=`${p.name}'s plan ‚Üí ${dist} km | ${time} mins`;
       renderVoting();
     }else alert('Directions failed: '+status);
   });
}

/* ===== Voting ===== */
function renderVoting(){
  const box=document.getElementById('votingContent'); if(!box)return;
  if(state.profiles.length===0){box.innerHTML='<em>No profiles yet</em>';return;}
  const places=[...new Set(state.profiles.flatMap(p=>p.stops))];
  if(places.length===0){box.innerHTML='<em>No stops to vote on</em>';return;}

  let html='<table><thead><tr><th>Place</th>';
  state.profiles.forEach(p=>html+=`<th>${p.name}</th>`); html+='<th>üëç</th><th>üëé</th></tr></thead><tbody>';
  places.forEach(pl=>{
    const row=state.votes[pl]||{};
    html+=`<tr><td>${pl}</td>`;
    state.profiles.forEach(p=>{
      const up=row[p.id];
      html+=`<td style="text-align:center"><button onclick="toggle('${pl}','${p.id}')">${up?'üëç':'üëé'}</button></td>`;
    });
    const yes=cnt(row,true), no=cnt(row,false);
    html+=`<td style="text-align:center">${yes}</td><td style="text-align:center">${no}</td></tr>`;
  });
  html+='</tbody></table>'; box.innerHTML=html;
}
function toggle(place,pid){
  if(!state.votes[place]) state.votes[place]={};
  state.votes[place][pid]=!state.votes[place][pid]; save(); renderVoting();
}
const cnt=(o,v)=>Object.values(o).filter(x=>x===v).length;

/* ===== Load Google API ===== */
(function(){
  const s=document.createElement('script');
  s.src='https://maps.googleapis.com/maps/api/js?key=AIzaSyAyb1r4lm4HGtyr2nEOuVL-kSdyEosZVh4&libraries=places&callback=initMap';
  s.async=true; document.head.appendChild(s);
})();
</script>
</body>
</html>
